name: "Android emulator"
on:
  workflow_dispatch:
env:
  DEBIAN_FRONTEND: noninteractive
  TZ: Asia/Jakarta
  NTFY: ${{ secrets.NTFY }}
jobs:
  launch_instance:
    runs-on: ubuntu-latest
    steps:
      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      - name: Setup host access
        run: |
          sudo apt -yq update; sudo apt -yq upgrade; sudo apt -yq install tmux openssh-client novnc tigervnc-standalone-server tigervnc-xorg-extension tzdata xserver-xorg-video-dummy icewm icewm-themes icemc iceconf icewm-gnome-support
          for a in autoremove purge clean; do sudo apt -yqq $a; done
          ssh-keygen -t ed25519 -q -f "$HOME/.ssh/id_ed25519" -N ""
          sudo chmod 600 "$HOME/.ssh/id_ed25519"
          curl -sL -o /usr/local/bin/ttyd $(curl -s 'https://api.github.com/repos/tsl0922/ttyd/releases/latest' | jq -r '.assets[] | select(.name|contains("x86_64")).browser_download_url')
          /usr/local/bin/ttyd -p 7681 -W -t titleFixed="ttyd - Android emulator" -t fontSize=13 -t fontFamily=monospace -m 1 /bin/bash -lc '/usr/bin/tmux a || /usr/bin/tmux' > /dev/null 2>&1 &
          /usr/bin/vncserver -geometry 1920x960 -localhost yes -alwaysshared -SecurityTypes none :1
          /usr/bin/websockify -D --web=/usr/share/novnc/ 6080 localhost:5901
          /usr/bin/ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ServerAliveInterval=5 -T srv.us -R 1:127.0.0.1:7681 -R 2:127.0.0.1:5901 -R 3:127.0.0.1:6080 &
      - name: run tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          emulator-options: -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
          script: while true; do sleep 300; done
      - name: Wait for stop signals
        run: |
          for a in {1..700}; do [ -f /tmp/poweroff ] && exit || sleep 30; done
