name: "Ubuntu Server"
on:
  workflow_dispatch:
env:
  DEBIAN_FRONTEND: noninteractive
  TZ: Asia/Jakarta
  NTFY: ${{ secrets.NTFY }}
jobs:
  launch_instance:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/msh128/ubuntu-docker:latest
      options: --user 1000 --device /dev/fuse --cap-add SYS_ADMIN --privileged
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.github_token }}
    steps:
      - name: Launch instance
        shell: bash
        run: |
          container_start () {
            sudo systemctl start sshd srv.us ttyd
            sudo systemctl start rclone-mounts 
            sudo systemctl start alist pgadmin4 prowlarr qbittorrent-nox
            sudo systemctl start teldrive teldrive-webdav xtigervncserver novnc
            sudo systemctl start config-sync
            curl -s -d "$(echo Connection information; sudo journalctl -u srv.us --no-pager | grep ': https')" ntfy.sh/$NTFY > /dev/null 2>&1
          }
          /usr/local/bin/ttyd -p 7681 -W -t fontSize=13 -t fontFamily=monospace -m 1 /bin/bash -lc '/usr/bin/tmux a || /usr/bin/tmux' &
          /usr/bin/ssh -o StrictHostKeyChecking=no -o BatchMode=yes -o ServerAliveInterval=5 -T srv.us -R 1:127.0.0.1:22 -R 2:127.0.0.1:7681 &
      - name: Wait for stop signals
        shell: bash
        run: |
          container_stop () {
            echo Stopping services
            sudo systemctl stop teldrive teldrive-webdav xtigervncserver novnc
            sudo systemctl stop alist pgadmin4 prowlarr qbittorrent-nox
            sudo systemctl stop rclone-mounts
            sudo systemctl stop config-sync
            exit
          }
          for a in {1..700}; do [ -f /tmp/poweroff ] && container_stop ||  sleep 30; done
